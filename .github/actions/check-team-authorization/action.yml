# Copyright (c) 2025 Mercedes-Benz AG
# Frank Spr√ºnken <accenture.spruenken@extaccount.com>
#
# Version History:
# 1.0.0 - 2025-11-24 - Initial release (F. Spruenken)
# 1.0.1 - 2026-01-26 - Added more logging (O. Weng)

name: 'Check Team Authorization'
description: 'Verifies if the workflow actor is a member of a specified GitHub team'
inputs:
  team-slug:
    description: 'Team slug to check membership against'
    required: true
  github-token:
    description: 'GitHub token with members:read permission'
    required: true
  organization:
    description: 'GitHub organization name (auto-detected if not provided)'
    required: false
    default: ''
outputs:
  authorized:
    description: 'Whether the user is authorized (true/false)'
    value: ${{ steps.check.outputs.authorized }}
  user:
    description: 'The username that was checked'
    value: ${{ github.actor }}
  organization:
    description: 'The organization that was checked'
    value: ${{ steps.check.outputs.organization }}
runs:
  using: 'composite'
  steps:
    - name: Check team membership
      id: check
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        GH_ENTERPRISE_TOKEN: ${{ inputs.github-token }}
      run: |
        set +e
        
        # Auto-detect organization from repository context
        if [ -z "${{ inputs.organization }}" ]; then
          ORG="${{ github.repository_owner }}"
        else
          ORG="${{ inputs.organization }}"
        fi
        
        # Get GitHub server URL and extract hostname
        GITHUB_URL="${{ github.server_url }}"
        GH_HOSTNAME=$(echo "$GITHUB_URL" | sed -e 's|^https://||' -e 's|^http://||' -e 's|/$||')
        
        TEAM_SLUG="${{ inputs.team-slug }}"
        ACTOR="${{ github.actor }}"
        
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üîê AUTHORIZATION CHECK"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üë§ User: $ACTOR"
        echo "üè¢ Organization: $ORG"
        echo "üë• Required Team: $TEAM_SLUG"
        echo "üì¶ Repository: ${{ github.repository }}"
        echo "üåê GitHub URL: $GITHUB_URL"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""
        
        # Save organization to output
        echo "organization=$ORG" >> $GITHUB_OUTPUT
        
        # Verify token is available
        if [ -z "$GH_TOKEN" ]; then
          echo "‚ùå ERROR: GitHub token is not set or empty"
          echo "authorized=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check if user is member of the authorized team
        response=$(gh api --hostname "$GH_HOSTNAME" \
          -H "Accept: application/vnd.github+json" \
          "/orgs/$ORG/teams/$TEAM_SLUG/memberships/$ACTOR" 2>&1)
        status=$?
        
        if [ $status -eq 0 ]; then
          echo "‚úÖ AUTHORIZATION SUCCESSFUL"
          echo ""
          echo "‚úì User $ACTOR is a member of '$TEAM_SLUG'"
          echo "‚úì Access granted (via membership API)"
          echo "‚è±Ô∏è  Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "authorized=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Alternative method - check if user is in team members list
        response2=$(gh api --hostname "$GH_HOSTNAME" \
          -H "Accept: application/vnd.github+json" \
          "/orgs/$ORG/teams/$TEAM_SLUG/members" 2>&1)
        status2=$?
        
        if [ $status2 -eq 0 ]; then
          TEAM_MEMBERS=$(echo "$response2" | jq -r '.[].login' 2>/dev/null)
          
          if echo "$TEAM_MEMBERS" | grep -q "^${ACTOR}$"; then
            echo "‚úÖ AUTHORIZATION SUCCESSFUL"
            echo ""
            echo "‚úì User $ACTOR is a member of '$TEAM_SLUG'"
            echo "‚úì Access granted (via team members list)"
            echo "‚è±Ô∏è  Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "authorized=true" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        
        # Authorization failed
        echo "‚ùå AUTHORIZATION FAILED"
        echo ""
        echo "‚úó User $ACTOR is NOT a member of '$TEAM_SLUG'"
        echo "‚úó Access denied"
        echo ""
        echo "üìã To gain access:"
        echo "   1. Check team membership at: $GITHUB_URL/orgs/$ORG/teams/$TEAM_SLUG"
        echo "   2. Contact your team administrator to request access"
        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "authorized=false" >> $GITHUB_OUTPUT
        exit 1